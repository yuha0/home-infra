resources:
- argocd.yaml
- cert-manager.yaml
- external-dns.yaml
- grafana.yaml
- ingress-nginx-external.yaml
- ingress-nginx-internal.yaml
- metallb-system.yaml

patches:
# Both Project and Application should have resource finalizer
- target:
    group: argoproj.io
  patch: |-
    - op: add
      path: /metadata/finalizers
      value:
      - resources-finalizer.argocd.argoproj.io
# Peg allowed repositories for all projects
# Peg destination server
- target:
    group: argoproj.io
    kind: AppProject
  patch: |-
    - op: add
      path: /spec/sourceRepos
      value:
      - "https://github.com/yuha0/home-infra.git"
    - op: add
      path: /spec/destinations/0/server
      value: https://kubernetes.default.svc
    - op: add
      path: /spec/signatureKeys
      value:
      - keyID: CD67D78AC53D68C5
# Peg source repository for all applications, only sync `main` branch
# Force sync policy
- target:
    group: argoproj.io
    kind: Application
  patch: |-
    - op: add
      path: /spec/source/repoURL
      value: "https://github.com/yuha0/home-infra.git"
    - op: add
      path: /spec/source/targetRevision
      value: main
    - op: add
      path: /spec/destination/server
      value: https://kubernetes.default.svc
    - op: add
      path: /spec/syncPolicy
      value:
        automated:
          allowEmpty: true
          prune: true
          selfHeal: true
