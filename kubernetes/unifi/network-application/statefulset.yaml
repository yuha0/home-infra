apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: unifi
spec:
  serviceName: unifi
  replicas: 1
  template:
    spec:
      securityContext:
        fsGroup: 999
        runAsGroup: 999
        runAsUser: 999
      initContainers:
      # - command:
      #   - /bin/bash
      #   - -c
      #   - mkdir -p /unifi/data/ && cp /tmp/unifi/config.gateway.json /unifi/data/config.gateway.json
      #   image: unifi
      #   name: config-init
      #   volumeMounts:
      #   - mountPath: /unifi/
      #     name: unifi-data
      #   - mountPath: /tmp/unifi
      #     name: unifi-config
      - command:
        - /bin/bash
        - -c
        - cp -r /usr/lib/unifi/* /tmp/usr-lib-unifi/ && chown -R unifi:unifi /tmp/usr-lib-unifi/
        image: unifi
        name: permission-fix
        securityContext:
          runAsUser: 0
        volumeMounts:
        - mountPath: /tmp/usr-lib-unifi/
          name: usr-lib-unifi
      containers:
      - name: unifi
        image: unifi
        imagePullPolicy: IfNotPresent
        env:
        - name: "DB_NAME"
          value: "unifi"
        - name: "DB_URI"
          value: "mongodb://unifi-mongodb.unifi.svc.cluster.local.:27017/unifi"
        - name: "JVM_MAX_HEAP_SIZE"
          value: "2048M"
        - name: "RUNAS_UID0"
          value: "false"
        - name: "STATDB_URI"
          value: "mongodb://unifi-mongodb.unifi.svc.cluster.local.:27017/unifi_stat"
        - name: "TZ"
          value: "UTC"
        - name: "UNIFI_GID"
          value: "999"
        - name: "UNIFI_STDOUT"
          value: "true"
        - name: "UNIFI_UID"
          value: "999"
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        - name: discovery
          containerPort: 10001
          protocol: UDP
        - name: https
          containerPort: 8443
          protocol: TCP
        - name: portal-http
          containerPort: 8880
          protocol: TCP
        - name: portal-https
          containerPort: 8843
          protocol: TCP
        - name: speedtest
          containerPort: 6789
          protocol: TCP
        - name: stun
          containerPort: 3478
          protocol: UDP
        - name: syslog
          containerPort: 5514
          protocol: UDP
        volumeMounts:
        - name: unifi-config
          mountPath: /tmp/unifi
        - name: unifi-data
          mountPath: /unifi
        - name: usr-lib-unifi
          mountPath: /usr/lib/unifi
        - name: var-run-unifi
          mountPath: /var/run/unifi
        livenessProbe:
          tcpSocket:
            port: 8443
          initialDelaySeconds: 0
          failureThreshold: 3
          timeoutSeconds: 1
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 8443
          initialDelaySeconds: 0
          failureThreshold: 3
          timeoutSeconds: 1
          periodSeconds: 10
        startupProbe:
          tcpSocket:
            port: 8443
          initialDelaySeconds: 0
          failureThreshold: 30
          timeoutSeconds: 1
          periodSeconds: 5
        resources:
          requests:
            memory: 3Gi
      volumes:
      - name: unifi-config
        configMap:
          name: unifi-config
      - name: unifi-data
        persistentVolumeClaim:
          claimName: unifi-unifi-data
      - name: usr-lib-unifi
        emptyDir: {}
      - name: var-run-unifi
        emptyDir: {}
